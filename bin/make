#!/usr/bin/env bash
set -euo pipefail

# Main script to download video, audio and build final video
# Usage: make_video VIDEO_URL AUDIO_URL

# Check arguments
if [ "$#" -ne 2 ]; then
  echo "Usage: $(basename "$0") VIDEO_URL AUDIO_URL" >&2
  echo "  VIDEO_URL: YouTube video URL" >&2
  echo "  AUDIO_URL: Direct URL to audio file (will be downloaded as WAV)" >&2
  exit 1
fi

VIDEO_URL="$1"
AUDIO_URL="$2"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Ensure all required scripts exist
for script in video audio build; do
  if [ ! -x "$SCRIPT_DIR/$script" ]; then
    echo "Error: Required script $SCRIPT_DIR/$script not found or not executable." >&2
    exit 1
  fi
done

echo "=== Step 1: Downloading video ==="
"$SCRIPT_DIR/video" "$VIDEO_URL" || { echo "Error: Video download failed"; exit 1; }

echo "=== Step 2: Downloading audio ==="
"$SCRIPT_DIR/audio" "$AUDIO_URL" || { echo "Error: Audio download failed"; exit 1; }

echo "=== Step 3: Building final video ==="
"$SCRIPT_DIR/build" || { echo "Error: Build failed"; exit 1; }

echo "=== All done! ==="
echo "Final video is available at: $(pwd)/result/video.mp4"
