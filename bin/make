#!/usr/bin/env bash
set -euo pipefail

# All-in-one script to download video, audio and build final video
# Usage: make VIDEO_URL AUDIO_URL

# Check arguments
if [ "$#" -ne 2 ]; then
  echo "Usage: $(basename "$0") VIDEO_URL AUDIO_URL" >&2
  echo "  VIDEO_URL: YouTube video URL" >&2
  echo "  AUDIO_URL: Direct URL to audio file (will be downloaded as WAV)" >&2
  exit 1
fi

VIDEO_URL="$1"
AUDIO_URL="$2"

# Check required tools
for cmd in yt-dlp curl ffmpeg; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: $cmd not found in PATH. Please install $cmd." >&2
    exit 127
  fi
done

# Create required directories
mkdir -p current videos

# Step 1: Download video
echo "=== Step 1: Downloading video ==="

# Clean YouTube URL - remove list parameter and other query parameters except v
# First check if it's a youtube.com URL with v parameter
if echo "$VIDEO_URL" | grep -q 'youtube\.com.*[?&]v='; then
  # Extract just the video ID
  VIDEO_ID=$(echo "$VIDEO_URL" | sed -n 's/.*[?&]v=\([^&]*\).*/\1/p')
  # Recreate a clean URL with only the v parameter
  CLEAN_VIDEO_URL="https://www.youtube.com/watch?v=${VIDEO_ID}"
  echo "Cleaned URL: $CLEAN_VIDEO_URL"
  VIDEO_URL="$CLEAN_VIDEO_URL"
# Check if it's a youtu.be URL
elif echo "$VIDEO_URL" | grep -q 'youtu\.be/'; then
  # Extract just the video ID from youtu.be URL
  VIDEO_ID=$(echo "$VIDEO_URL" | sed -n 's|.*/\([^/?]*\).*|\1|p')
  # Recreate a clean URL
  CLEAN_VIDEO_URL="https://youtu.be/${VIDEO_ID}"
  echo "Cleaned URL: $CLEAN_VIDEO_URL"
  VIDEO_URL="$CLEAN_VIDEO_URL"
fi

# Validate YouTube URL
case "$VIDEO_URL" in
  http://youtube.com/*|https://youtube.com/*|http://www.youtube.com/*|https://www.youtube.com/*|http://youtu.be/*|https://youtu.be/*)
    ;;
  *)
    echo "Error: Video URL must be a YouTube link (youtube.com or youtu.be)." >&2
    exit 1
    ;;
esac

# Extract video ID from URL (using the already extracted ID or re-extract if needed)
if [ -z "${VIDEO_ID:-}" ]; then
  VIDEO_ID=$(echo "$VIDEO_URL" | sed -n 's/.*[?&]v=\([^&]*\).*/\1/p')
  if [ -z "$VIDEO_ID" ]; then
    # Try youtu.be format
    VIDEO_ID=$(echo "$VIDEO_URL" | sed -n 's|.*/\([^/?]*\).*|\1|p')
  fi

  if [ -z "$VIDEO_ID" ]; then
    echo "Error: Could not extract video ID from URL." >&2
    exit 1
  fi
fi

echo "Video ID: $VIDEO_ID"

# First get the title without downloading
echo "Getting video title..."
VIDEO_TITLE=$(yt-dlp --get-title --cookies-from-browser chrome --proxy socks5://127.0.0.1:8080  "$VIDEO_URL")
echo "Video title: $VIDEO_TITLE"

# Sanitize title for filename (remove special characters)
SAFE_TITLE=$(echo "$VIDEO_TITLE" | tr -c '[:alnum:]_-' '_' | sed 's/__*/_/g' | sed 's/^_//;s/_$//')

# Final output filename
OUTPUT_FILENAME="${SAFE_TITLE}-${VIDEO_ID}.mp4"
echo "Output filename: $OUTPUT_FILENAME"

# Now download the video
echo "Downloading video from: $VIDEO_URL"
rm -rf "current/*"

yt-dlp \
  --cookies-from-browser chrome \
  --proxy socks5://127.0.0.1:8080 \
  -o 'current/video.mp4' \
  -f 'bv*[ext=mp4]' \
  "$VIDEO_URL" || { echo "Error: Video download failed"; exit 1; }

# Verify video file exists
if [ ! -f "current/video.mp4" ]; then
  echo "Error: Video download failed. File not created." >&2
  exit 1
fi

# Step 2: Download audio
echo "=== Step 2: Downloading audio ==="
echo "Downloading audio from: $AUDIO_URL"
curl -L --fail --silent --show-error --output "current/audio.wav" "$AUDIO_URL" || { echo "Error: Audio download failed"; exit 1; }

# Verify audio file exists
if [ ! -f "current/audio.wav" ]; then
  echo "Error: Audio download failed. File not created." >&2
  exit 1
fi

# Step 3: Build final video
echo "=== Step 3: Building final video ==="

# Remove audio from video first
echo "Step 3.1: Removing audio from video..."
ffmpeg -i "current/video.mp4" -c:v copy -an "current/video_noaudio.mp4" -y

# Verify intermediate file exists
if [ ! -f "current/video_noaudio.mp4" ]; then
  echo "Error: Failed to create video without audio." >&2
  exit 1
fi

# Merge video with new audio
echo "Step 3.2: Merging with new audio..."
ffmpeg -i "current/video_noaudio.mp4" -i "current/audio.wav" \
  -c:v copy -c:a aac -strict experimental \
  -map 0:v:0 -map 1:a:0 \
  -shortest \
  "videos/${OUTPUT_FILENAME}" -y

# Clean up temporary files
rm -rf "current/*"

echo "=== All done! ==="
echo "Final video is available at: $(pwd)/videos/${OUTPUT_FILENAME}"
